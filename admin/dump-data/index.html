<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans'; background: #fff; color: #111827; padding: 16px; }
    h2 { font-size: 16px; margin: 8px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    thead th { background: #eef2ff; position: sticky; top: 0; z-index: 1; }
    th, td { border: 1px solid #cbd5e1; padding: 6px 8px; text-align: right; min-width: 100px; }
    th:first-child, td:first-child { text-align: left; }
    tbody td:first-child { font-weight: 600; }
    ol { padding-left: 18px; }
    button { padding: 6px 10px; border: 1px solid #cbd5e1; background: #f8fafc; border-radius: 6px; cursor: pointer; }
    button:hover { background: #eef2ff; }
    td[contenteditable="true"] { background: #ffffff; }
    td.editing { outline: 2px solid #93c5fd; }
    input, select { font-family: inherit; font-size: 14px; }
    .input { padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 6px; background:#fff; }
  </style>
</head>
<body>
  <div id="controls" style="position:sticky; top:0; background:#ffffff; z-index:3; padding-bottom:8px; display:flex; gap:8px; align-items:center; border-bottom: 1px dashed #e5e7eb;">
    <button id="btnEdit">Edit</button>
    <button id="btnSave">Save</button>
    <select id="presetSelect" class="input"></select>
    <button id="btnNewPreset">New</button>
    <button id="btnRenamePreset">Rename</button>
    <button id="btnDeletePreset">Delete</button>
    
    <a id="apiLink" href="#" target="_blank" style="font-size:12px; color:#2563eb; text-decoration:underline; white-space:nowrap;">API Link</a>
    <button id="btnCopyLink">Copy Link</button>
    <span id="status" style="margin-left:auto; font-size:12px; color:#6b7280;">View mode</span>
  </div>
  <table id="scanTable" style="margin-top:16px; display:none;">
    <thead>
      <tr>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr data-metric="views">
        <td>views</td>
      </tr>
      <tr data-metric="likes">
        <td>likes</td>
      </tr>
      <tr data-metric="comments">
        <td>comments</td>
      </tr>
  <tr data-metric="saves">
        <td>saves</td>
      </tr>
      <tr data-metric="shares">
        <td>shares</td>
      </tr>
  
  
      <tr>
        <td>--ratios--</td>
      </tr>
      <tr data-metric="likes_ratio">
        <td>likes</td>
      </tr>
      <tr data-metric="comments_ratio">
        <td>comments</td>
      </tr>
  <tr data-metric="saves_ratio">
        <td>saves</td>
      </tr>
      <tr data-metric="shares_ratio">
        <td>shares</td>
      </tr>
  
    </tbody>
    
  </table>
  <script>
    (async function () {
      const POST_URL_EXPECTED = 'https://www.tiktok.com/@bluetickstories/video/7543655894429551927';
      function isAuthorized() {
        const loc = window.location;
        const hostOk = (
          (loc.hostname === '127.0.0.1' && loc.port === '5500') ||
          loc.hostname === 'algotester.site' ||
          loc.hostname.endsWith('.vercel.app')
        );
        const params = new URLSearchParams(loc.search);
        const qOk = (
          params.get('securityToken') === '59LdrEJCGFlfGNN' &&
          params.get('adminToken') === 'assist_aff' &&
          decodeURIComponent(params.get('postUrl') || '') === POST_URL_EXPECTED
        );
        const pathOk = (loc.hostname === '127.0.0.1') ? (loc.pathname === '/admin/dump-data/') : true;
        return hostOk && qOk && pathOk;
      }
      if (!isAuthorized()) { document.body.innerHTML = 'Not authorized'; return; }
      const table = document.getElementById('scanTable');
      const headerRow = table.querySelector('thead tr');
      const metricRows = {
        views: table.querySelector('tr[data-metric="views"]'),
        likes: table.querySelector('tr[data-metric="likes"]'),
        comments: table.querySelector('tr[data-metric="comments"]'),
        saves: table.querySelector('tr[data-metric="saves"]'),
        shares: table.querySelector('tr[data-metric="shares"]'),
        likes_ratio: table.querySelector('tr[data-metric="likes_ratio"]'),
        comments_ratio: table.querySelector('tr[data-metric="comments_ratio"]'),
        saves_ratio: table.querySelector('tr[data-metric="saves_ratio"]'),
        shares_ratio: table.querySelector('tr[data-metric="shares_ratio"]')
      };
      const btnEdit = document.getElementById('btnEdit');
      const btnSave = document.getElementById('btnSave');
      const statusEl = document.getElementById('status');
      const presetSelect = document.getElementById('presetSelect');
      const btnNewPreset = document.getElementById('btnNewPreset');
      const btnRenamePreset = document.getElementById('btnRenamePreset');
      const btnDeletePreset = document.getElementById('btnDeletePreset');
      // Fixed to TikTok post URL
      const FIXED_POST_URL = 'https://www.tiktok.com/@bluetickstories/video/7543655894429551927';
      const apiLink = document.getElementById('apiLink');
      const btnCopyLink = document.getElementById('btnCopyLink');
      
      const MAX_SCANS = 30;

      function parseNumber(text) {
        if (text == null) return 0;
        const cleaned = String(text).replace(/,/g, '').replace(/%/g, '').trim();
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : 0;
      }

      function formatInteger(n) {
        return Math.round(n).toLocaleString('en-US');
      }

      function formatPercent(n, decimals) {
        return (Number.isFinite(n) ? n : 0).toFixed(decimals) + '%';
      }

      function getColumnCount() { return headerRow.children.length - 1; }

      function computeRatiosForColumn(colIndex) {
        // colIndex is 1-based for table cells (skip first label cell)
        const v = parseNumber(metricRows.views.children[colIndex].textContent);
        const l = parseNumber(metricRows.likes.children[colIndex].textContent);
        const c = parseNumber(metricRows.comments.children[colIndex].textContent);
        const s = parseNumber(metricRows.saves.children[colIndex].textContent);
        const h = parseNumber(metricRows.shares.children[colIndex].textContent);
        if (v <= 0) {
          metricRows.likes_ratio.children[colIndex].textContent = '0.00%';
          metricRows.comments_ratio.children[colIndex].textContent = '0.000%';
          metricRows.saves_ratio.children[colIndex].textContent = '0.00%';
          metricRows.shares_ratio.children[colIndex].textContent = '0.000%';
          return;
        }
        metricRows.likes_ratio.children[colIndex].textContent = formatPercent((l / v) * 100, 2);
        metricRows.comments_ratio.children[colIndex].textContent = formatPercent((c / v) * 100, 3);
        metricRows.saves_ratio.children[colIndex].textContent = formatPercent((s / v) * 100, 2);
        metricRows.shares_ratio.children[colIndex].textContent = formatPercent((h / v) * 100, 3);
      }

      function recomputeAllRatios() { for (let i = 1; i < headerRow.children.length; i++) computeRatiosForColumn(i); }

      function enableEditing() {
        ['views', 'likes', 'comments', 'saves', 'shares'].forEach(metric => {
          const row = metricRows[metric];
          for (let i = 1; i < row.children.length; i++) {
            const td = row.children[i];
            td.setAttribute('contenteditable', 'true');
          }
        });
        table.addEventListener('focusin', e => {
          if (e.target && e.target.matches('td[contenteditable="true"]')) {
            e.target.classList.add('editing');
          }
        });
        table.addEventListener('focusout', e => {
          if (e.target && e.target.matches('td[contenteditable="true"]')) {
            const td = e.target;
            td.classList.remove('editing');
            const raw = parseNumber(td.textContent);
            td.textContent = formatInteger(raw);
            const colIndex = Array.from(td.parentElement.children).indexOf(td);
            computeRatiosForColumn(colIndex);
            autoSave();
          }
        });
        table.addEventListener('keydown', e => {
          if (e.key === 'Enter' && e.target && e.target.matches('td[contenteditable="true"]')) {
            e.preventDefault();
            e.target.blur();
          }
        });
      }

      function disableEditing() {
        ['views', 'likes', 'comments', 'saves', 'shares'].forEach(metric => {
          const row = metricRows[metric];
          for (let i = 1; i < row.children.length; i++) {
            const td = row.children[i];
            td.removeAttribute('contenteditable');
            td.classList.remove('editing');
          }
        });
      }

      // No add/duplicate UI anymore

      function readData() {
        const labels = [];
        for (let i = 1; i < headerRow.children.length; i++) labels.push(headerRow.children[i].textContent);
        const metrics = {};
        ['views', 'likes', 'comments', 'saves', 'shares'].forEach(metric => {
          const row = metricRows[metric];
          const arr = [];
          for (let i = 1; i < row.children.length; i++) arr.push(parseNumber(row.children[i].textContent));
          metrics[metric] = arr;
        });
        return { labels, metrics };
      }

      function rebuildFromData(data) {
        // Clear existing columns (keep first label th/td)
        while (headerRow.children.length > 1) headerRow.removeChild(headerRow.lastElementChild);
        Object.keys(metricRows).forEach(key => {
          const row = metricRows[key];
          while (row.children.length > 1) row.removeChild(row.lastElementChild);
        });
        // Rebuild
        data.labels.forEach((label) => {
          const th = document.createElement('th');
          th.textContent = label;
          headerRow.appendChild(th);
        });
        ['views', 'likes', 'comments', 'saves', 'shares'].forEach(metric => {
          const row = metricRows[metric];
          (data.metrics[metric] || []).forEach((val) => {
            const td = document.createElement('td');
            td.textContent = formatInteger(val);
            row.appendChild(td);
          });
        });
        ['likes_ratio', 'comments_ratio', 'saves_ratio', 'shares_ratio'].forEach(metric => {
          const row = metricRows[metric];
          for (let i = 1; i < headerRow.children.length; i++) {
            const td = document.createElement('td');
            td.textContent = '0%';
            row.appendChild(td);
          }
        });
        recomputeAllRatios();
      }

      function getApiBase() {
        const params = new URLSearchParams(location.search);
        const apiBase = params.get('apiBase');
        if (apiBase) return apiBase;
        // Default: same-origin (works on Vercel and custom domains pointing to it)
        return location.origin;
      }
      function getAuthQuery() {
        const params = new URLSearchParams(location.search);
        const securityToken = params.get('securityToken') || '';
        const adminToken = params.get('adminToken') || '';
        const preset = params.get('preset') || 'default';
        const postUrl = params.get('postUrl') || '';
        return `securityToken=${encodeURIComponent(securityToken)}&adminToken=${encodeURIComponent(adminToken)}&preset=${encodeURIComponent(preset)}&postUrl=${encodeURIComponent(postUrl)}`;
      }
      function getPreset() { return new URLSearchParams(location.search).get('preset') || 'default'; }
      function setPreset(preset) {
        const params = new URLSearchParams(location.search);
        params.set('preset', preset);
        const url = `${location.pathname}?${params.toString()}`;
        history.replaceState(null, '', url);
      }
      async function saveState() {
        const data = readData();
        clampToMaxScans();
        try {
          const res = await fetch(`${getApiBase()}/api/scans?${getAuthQuery()}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          if (!res.ok) {
            let msg = '';
            try { const t = await res.text(); msg = t; } catch (e) {}
            throw new Error(`Save failed (${res.status}) ${msg}`);
          }
          statusEl.textContent = 'Saved';
        } catch (e) {
          console.error(e);
          statusEl.textContent = String(e.message || e);
        }
      }
      function autoSave() { try { saveState(); } catch (e) {} }
      async function loadState() {
        try {
          const res = await fetch(`${getApiBase()}/api/scans?${getAuthQuery()}`, { cache: 'no-store' });
          if (res.ok) {
            const data = await res.json();
            rebuildFromData({ labels: data.labels, metrics: data.metrics });
            clampToMaxScans();
            updateApiLink();
            return true;
          }
          if (res.status !== 404) {
            let msg = '';
            try { msg = await res.text(); } catch (e) {}
            statusEl.textContent = `Load failed (${res.status}) ${msg}`;
          }
          // If not found, try to seed from 'default' preset
          const params = new URLSearchParams(location.search);
          const currentPreset = params.get('preset') || 'default';
          if (currentPreset !== 'default') {
            const seedParams = new URLSearchParams(location.search);
            seedParams.set('preset', 'default');
            const seedUrl = `${getApiBase()}/api/scans?securityToken=${encodeURIComponent(seedParams.get('securityToken')||'')}&adminToken=${encodeURIComponent(seedParams.get('adminToken')||'')}&preset=default&postUrl=${encodeURIComponent(seedParams.get('postUrl')||'')}`;
            try {
              const seedRes = await fetch(seedUrl, { cache: 'no-store' });
              if (seedRes.ok) {
                const seedData = await seedRes.json();
                rebuildFromData({ labels: seedData.labels, metrics: seedData.metrics });
                clampToMaxScans();
                // Persist seeded data into the current preset
                await saveState();
                return true;
              }
            } catch (e) { /* ignore */ }
          }
        } catch (e) { /* ignore */ }
        return false;
      }

      // removed ensureDefaultParams; tokens must be present in URL

      async function refreshPresetList() {
        try {
          const res = await fetch(`${getApiBase()}/admin/dump-data/api/scans?${getAuthQuery()}&manage=list`, { cache: 'no-store' });
          const data = res.ok ? await res.json() : { presets: [] };
          const current = getPreset();
          const list = Array.isArray(data.presets) ? data.presets : [];
          presetSelect.innerHTML = '';
          const ensure = (arr, name) => (arr.includes(name) ? arr : arr.concat([name]));
          ensure(list, 'default').forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            if (name === current) opt.selected = true;
            presetSelect.appendChild(opt);
          });
        } catch (e) { /* ignore */ }
      }

      function updateApiLink() {
        apiLink.href = location.href;
        apiLink.textContent = 'API Link';
      }

      function clampToMaxScans() {
        const current = headerRow.children.length - 1;
        if (current <= MAX_SCANS) return;
        // Remove extra headers
        while (headerRow.children.length - 1 > MAX_SCANS) headerRow.removeChild(headerRow.lastElementChild);
        // Remove extra cells per row
        Object.values(metricRows).forEach(row => {
          while (row.children.length - 1 > MAX_SCANS) row.removeChild(row.lastElementChild);
        });
        recomputeAllRatios();
      }

      // removed all JSON file picker/download helpers
      // Controls wiring
      btnEdit.addEventListener('click', () => { enableEditing(); statusEl.textContent = 'Edit mode'; });
      btnSave.addEventListener('click', () => { disableEditing(); saveState(); statusEl.textContent = 'View mode'; });
      btnCopyLink.addEventListener('click', async () => {
        try {
          updateApiLink();
          await navigator.clipboard.writeText(apiLink.href);
          statusEl.textContent = 'Link copied';
          setTimeout(() => statusEl.textContent = 'View mode', 1200);
        } catch (e) {
          statusEl.textContent = 'Copy failed';
          setTimeout(() => statusEl.textContent = 'View mode', 1200);
        }
      });

      presetSelect.addEventListener('change', async () => {
        setPreset(presetSelect.value);
        statusEl.textContent = 'Loading...';
        await loadState();
        recomputeAllRatios();
        statusEl.textContent = 'View mode';
        updateApiLink();
      });

      btnNewPreset.addEventListener('click', async () => {
        const name = prompt('New preset name?');
        if (!name) return;
        const body = { name: name, copyFrom: getPreset() };
        try {
          const res = await fetch(`${getApiBase()}/admin/dump-data/api/scans?${getAuthQuery()}&manage=create`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
          });
          if (res.ok) {
            setPreset(name);
            await refreshPresetList();
            await loadState();
            recomputeAllRatios();
          }
        } catch (e) {}
      });

      btnRenamePreset.addEventListener('click', async () => {
        const current = getPreset();
        const newName = prompt('Rename preset to?', current);
        if (!newName || newName === current) return;
        try {
          const res = await fetch(`${getApiBase()}/admin/dump-data/api/scans?${getAuthQuery()}&manage=rename`, {
            method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ oldName: current, newName })
          });
          if (res.ok) {
            setPreset(newName);
            await refreshPresetList();
            await loadState();
            recomputeAllRatios();
            statusEl.textContent = 'Renamed';
            setTimeout(() => statusEl.textContent = 'View mode', 1200);
          }
        } catch (e) {}
      });

      btnDeletePreset.addEventListener('click', async () => {
        const current = getPreset();
        if (!confirm(`Delete preset "${current}"?`)) return;
        try {
          const res = await fetch(`${getApiBase()}/admin/dump-data/api/scans?${getAuthQuery()}&manage=delete`, {
            method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: current })
          });
          if (res.ok) {
            setPreset('default');
            await refreshPresetList();
            await loadState();
            recomputeAllRatios();
            statusEl.textContent = 'Deleted';
            setTimeout(() => statusEl.textContent = 'View mode', 1200);
          }
        } catch (e) {}
      });
      

      // Init - keep page gated until data is ready
      statusEl.textContent = 'Loading...';
      document.documentElement.setAttribute('data-ready', '0');
      clampToMaxScans();
      recomputeAllRatios();
      updateApiLink();

      async function waitForDataAndShow() {
        // First immediate attempt
        let ready = await loadState();
        if (!ready) {
          // Poll until available, up to ~30s
          const maxAttempts = 20;
          for (let attempt = 1; attempt <= maxAttempts && !ready; attempt++) {
            await new Promise(r => setTimeout(r, 1500));
            ready = await loadState();
          }
        }
        // Reveal page (even if not ready after timeout)
        table.style.display = 'table';
        statusEl.textContent = ready ? 'View mode' : 'View mode (no data)';
        document.documentElement.setAttribute('data-ready', ready ? '1' : '0');
        disableEditing();
      }

      await refreshPresetList();
      await waitForDataAndShow();
    })();
  </script>
</body>
</html>

    